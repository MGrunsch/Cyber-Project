<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Finanzverwaltung</title>
    <link rel="stylesheet" th:href="@{/css/login_registration.css}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const apiClient = axios.create();

        apiClient.interceptors.request.use(config => {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                config.headers['Authorization'] = 'Bearer ' + token;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        window.login = function (event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            apiClient.post('/api/auth/signin', {username, password})
                .then(response => {
                    console.log(response)
                    if (response.data.requirePushNot) {
                        document.getElementById('pushNotificationMessage').style.display = 'block';
                        document.getElementById('loginButton').style.display = 'none';
                        window.open(response.data.pushNotificationUrl, 'Push Notification', 'width=600,height=400');
                    } else if (response.data.requireOTP) {
                        document.getElementById('otpField').style.display = 'block';
                        document.getElementById('loginButton').style.display = 'none';
                        document.getElementById('otpButton').style.display = 'block';
                        document.getElementById('wrongPasswordMessage').style.display = 'none';

                        if (response.data.phoneNumber) {
                            // SMS OTP
                            document.getElementById('otpPhoneMessage').style.display = 'block';
                            document.getElementById('userPhoneNumber').textContent = response.data.phoneNumber;
                            document.getElementById('otpSentMessage').style.display = 'none';
                        } else {
                            // E-Mail OTP
                            document.getElementById('otpSentMessage').style.display = 'block';
                            document.getElementById('otpPhoneMessage').style.display = 'none';
                        }
                    } else if (response.data.token) {
                        handleSuccessfulLogin(response.data.token);
                    } else {
                        alert('Login fehlgeschlagen');
                    }
                })
                .catch(error => {
                    document.getElementById('wrongPasswordMessage').style.display = 'block';
                });
        };

        function verifyOTP() {
            const username = document.getElementById('username').value;
            const otp = document.getElementById('otp').value;

            apiClient.post('/api/auth/verify-otp', {username, otp})
                .then(response => {
                    if (response.data.token) {
                        handleSuccessfulLogin(response.data.token);
                    } else {
                        document.getElementById('wrongOTPMessage').style.display = 'block';
                    }
                })
                .catch(error => {
                    document.getElementById('wrongOTPMessage').style.display = 'block';
                });
        }

        function handleSuccessfulLogin(token) {
            localStorage.setItem('jwtToken', token);
            navigateTo("/dashboard");
        }

        function navigateTo(url) {
            apiClient.get(url)
                .then(response => {
                    document.querySelector('.main-content').innerHTML = response.data; // Nur den Inhalt ersetzen
                })
                .catch(error => {
                    console.error('Error beim Navigieren:', error);
                    if (error.response && error.response.status === 401) {
                        window.location.href = '/finance-management';
                    } else {
                        alert('Navigation fehlgeschlagen');
                    }
                });
        }

        document.addEventListener('click', function (e) {
            if (e.target.tagName === 'A' && e.target.getAttribute('href')) {
                e.preventDefault();
                navigateTo(e.target.getAttribute('href'));
            }
        });

        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/finance-management';
        }

        function transferMoney() {
            const recipientId = document.getElementById('recipient').value;
            const amount = document.getElementById('amount').value;

            console.log('Überweisung:', {recipientId, amount});
            console.log('Aktueller Token:', localStorage.getItem('jwtToken')); // Debugging-Log

            apiClient.post('/api/auth/transfer', {recipientId, amount})
                .then(response => {
                    console.log('Überweisung erfolgreich:', response.data);
                    navigateTo('/dashboard');
                })
                .catch(error => {
                    console.error('Error bei der Überweisung:', error);
                    alert('Überweisung fehlgeschlagen');
                });
        }

        window.handlePushConfirmation = function(confirmed, token) {
            if (confirmed && token) {
                handleSuccessfulLogin(token);
            } else {
                document.getElementById('pushNotificationMessage').style.display = 'none';
                document.getElementById('loginButton').style.display = 'block';
            }
        };
    </script>
</head>
<body>
<main class="main-content">
    <div class="auth-container">
        <div class="auth-box">
            <h1 class="auth-title">Finanzverwaltung - Login</h1>
            <div th:if="${param.error}" class="message error">
                <p>Ungültige Anmeldedaten. Bitte versuchen Sie es erneut.</p>
            </div>

            <div th:if="${param.logout}" class="message success">
                <p>Sie haben sich erfolgreich ausgeloggt!</p>
            </div>

            <div id="otpSentMessage" class="message message-info" style="display: none;">
                <p>Ein Einmal-Passwort wurde an Ihre E-Mail-Adresse gesendet. Bitte überprüfen Sie Ihr Postfach.</p>
            </div>

            <div id="wrongPasswordMessage" class="message error" style="display: none;">
                <p>Das Passwort ist falsch. Bitte versuchen Sie es erneut.</p>
            </div>

            <div id="wrongOTPMessage" class="message message-info" style="display: none;">
                <p>OTP-Verifizierung fehlgeschlagen</p>
            </div>

            <div id="otpPhoneMessage" class="message message-info" style="display: none;">
                <p>Ein Einmal-Passwort wurde an Ihre Telefonnummer <span id="userPhoneNumber"></span> gesendet.</p>
            </div>

            <div id="pushNotificationMessage" class="message message-info" style="display: none;">
                <p>Eine Push-Benachrichtigung wurde gesendet. Bitte bestätigen Sie diese, um fortzufahren.</p>
            </div>

            <form id="loginForm" class="auth-form" onsubmit="login(event)">
                <div class="form-group">
                    <label for="username">E-Mail:</label>
                    <input type="text" id="username" name="username" required class="form-input"/>
                </div>
                <div class="form-group">
                    <label for="password">Passwort:</label>
                    <input type="password" id="password" name="password" required class="form-input"/>
                </div>
                <div id="otpField" style="display: none;" class="form-group">
                    <label for="otp">One-Time Password:</label>
                    <input type="text" id="otp" name="otp" class="form-input"/>
                </div>
                <button id="loginButton" type="submit" class="auth-button">Anmelden</button>
                <button id="otpButton" type="button" onclick="verifyOTP()" style="display: none;" class="auth-button">
                    OTP verifizieren
                </button>
            </form>

            <div class="auth-links">
                <p>Noch kein Konto? <a th:href="@{/register}">Hier registrieren</a></p>
            </div>
        </div>
    </div>
</main>
</body>
</html>
