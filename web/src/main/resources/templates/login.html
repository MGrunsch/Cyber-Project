<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Finanzverwaltung</title>
    <link rel="stylesheet" th:href="@{/css/login_registration.css}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const apiClient = axios.create();

        apiClient.interceptors.request.use(config => {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                config.headers['Authorization'] = 'Bearer ' + token;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        window.login = function(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            apiClient.post('/api/auth/signin', { username, password })
                .then(response => {
                    console.log(response);
                    if (response.data.requireSecurityQuestion) {
                        document.getElementById('securityQuestionField').style.display = 'block';
                        document.getElementById('securityQuestionLabel').innerText = response.data.securityQuestion;
                        document.getElementById('loginButton').style.display = 'none';
                        document.getElementById('verifySecurityQuestionButton').style.display = 'block';
                    }
                    else if (response.data.requireOTP) {
                        console.log("Otp required");
                        document.getElementById('otpField').style.display = 'block';
                        document.getElementById('loginButton').style.display = 'none';
                        document.getElementById('otpButton').style.display = 'block';
                    } else if (response.data.token) {
                        handleSuccessfulLogin(response.data.token);
                    } else {
                        alert('Login fehlgeschlagen');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ein Fehler ist aufgetreten');
                });
        };

        function verifyOTP() {
            const username = document.getElementById('username').value;
            const otp = document.getElementById('otp').value;

            apiClient.post('/api/auth/verify-otp', { username, otp })
                .then(response => {
                    if (response.data.token) {
                        handleSuccessfulLogin(response.data.token);
                    } else {
                        alert('OTP-Verifizierung fehlgeschlagen');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('OTP-Verifizierung fehlgeschlagen');
                });
        }

        function handleSuccessfulLogin(token) {
            localStorage.setItem('jwtToken', token);
            navigateTo("/dashboard");
        }

        function navigateTo(url) {
            apiClient.get(url)
                .then(response => {
                    document.querySelector('.main-content').innerHTML = response.data; // Nur den Inhalt ersetzen
                })
                .catch(error => {
                    console.error('Error beim Navigieren:', error);
                    if (error.response && error.response.status === 401) {
                        window.location.href = '/finance-management';
                    } else {
                        alert('Navigation fehlgeschlagen');
                    }
                });
        }

        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.getAttribute('href')) {
                e.preventDefault();
                navigateTo(e.target.getAttribute('href'));
            }
        });

        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/finance-management';
        }


        function transferMoney() {
            const recipientId = document.getElementById('recipient').value;
            const amount = parseFloat(document.getElementById('amount').value);


            if (amount > 500) {

                // API-Aufruf zur OTP-Generierung
                apiClient.post('/api/auth/transfer', { recipientId, amount })
                    .then(response => {
                        if (response.data.requireOTP) {
                            // Zeige OTP-Feld
                            document.getElementById('transferOtpField').style.display = 'block';
                            document.getElementById('transferButton').style.display = 'none';
                            document.getElementById('otpTransferButton').style.display = 'block';

                            // Speichere die Transferdetails temporär
                            window.pendingTransfer = { recipientId, amount };
                            alert('OTP wurde an Ihre E-Mail-Adresse gesendet.');
                        } else {
                            alert('Überweisung erfolgreich.');
                            navigateTo("/dashboard");
                        }
                    })
                    .catch(error => {
                        console.error('Fehler beim Senden des OTP:', error);
                        alert('Es gab ein Problem beim Verarbeiten des Transfers. Bitte versuchen Sie es erneut.');
                    });
            } else {
                // Direkter Transfer ohne OTP
                apiClient.post('/api/auth/transfer', { recipientId, amount })
                    .then(response => {
                        alert('Überweisung erfolgreich.');
                        navigateTo("/dashboard");
                    })
                    .catch(error => {
                        console.error('Fehler bei der Überweisung:', error);
                        alert('Überweisung fehlgeschlagen.');
                    });
            }
        }

        function verifyTransferOTP() {
            const otp = document.getElementById('transferOtp').value;
            const recipientId = document.getElementById('recipient').value;
            const amount = document.getElementById('amount').value;

            // API-Aufruf zur OTP-Überprüfung und Transferausführung
            apiClient.post('/api/auth/verify-transfer-otp', { recipientId, amount, otp })
                .then(response => {
                    alert('Transfer erfolgreich!');
                    navigateTo("/dashboard");

                })
                .catch(error => {
                    console.error('Fehler bei der OTP-Überprüfung:', error);
                    alert('OTP-Überprüfung fehlgeschlagen. Bitte prüfen Sie das OTP und versuchen Sie es erneut.');
                });
        }

        function verifySecurityQuestion() {
            const username = document.getElementById('username').value;
            const answer = document.getElementById('securityAnswer').value;

            apiClient.post('/api/auth/verify-security-question', { username, answer })
                .then(response => {
                    if (response.data.token) {
                        // JWT speichern
                        localStorage.setItem('jwtToken', response.data.token);
                        // Weiter zum Dashboard
                        navigateTo("/dashboard");
                    } else {
                        alert('Antwort auf die Sicherheitsfrage ist falsch');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Fehler bei der Verifizierung der Sicherheitsfrage.');
                });
        }

    </script>
</head>
<body>
<main class="main-content">
    <div class="auth-container">
        <div class="auth-box">
            <h1 class="auth-title">Finanzverwaltung - Login</h1>
            <div th:if="${param.error}" class="message error">
                <p>Ungültige Anmeldedaten. Bitte versuchen Sie es erneut.</p>
            </div>

            <div th:if="${param.logout}" class="message success">
                <p>Sie haben sich erfolgreich ausgeloggt!</p>
            </div>

            <form id="loginForm" class="auth-form" onsubmit="login(event)">
                <div class="form-group">
                    <label for="username">E-Mail:</label>
                    <input type="text" id="username" name="username" required class="form-input"/>
                </div>
                <div class="form-group">
                    <label for="password">Passwort:</label>
                    <input type="password" id="password" name="password" required class="form-input"/>
                </div>
                <div id="otpField" style="display: none;" class="form-group">
                    <label for="otp">One-Time Password:</label>
                    <input type="text" id="otp" name="otp" class="form-input"/>
                </div>
                <div id="securityQuestionField" style="display: none;" class="form-group">
                    <label id="securityQuestionLabel"></label>
                    <input type="text" id="securityAnswer" name="securityAnswer" class="form-input"/>
                </div>
                <button id="verifySecurityQuestionButton" type="button" onclick="verifySecurityQuestion()" style="display: none;" class="auth-button">
                    Sicherheitsfrage beantworten
                </button>
                <button id="loginButton" type="submit" class="auth-button">Anmelden</button>
                <button id="otpButton" type="button" onclick="verifyOTP()" style="display: none;" class="auth-button">OTP verifizieren</button>
            </form>

            <div class="auth-links">
                <p>Noch kein Konto? <a th:href="@{/register}">Hier registrieren</a></p>
            </div>
        </div>
    </div>
</main>
</body>
</html>
