<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Finanzverwaltung</title>
    <link rel="stylesheet" th:href="@{/css/login_registration.css}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const apiClient = axios.create();

        apiClient.interceptors.request.use(config => {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                config.headers['Authorization'] = 'Bearer ' + token;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        window.login = function(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            apiClient.post('/api/auth/signin', { username, password })
                .then(response => {
                    if (response.data.token) {
                        localStorage.setItem('jwtToken', response.data.token);

                        apiClient.get('/dashboard')
                            .then(response => {
                                navigateTo("/dashboard")
                            })
                            .catch(error => {
                                console.error('Error beim Zugriff auf das Dashboard:', error);
                                alert('Zugriff auf das Dashboard fehlgeschlagen');
                            });


                    } else {
                        alert('Login fehlgeschlagen');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ein Fehler ist aufgetreten');
                });
        };

        function navigateTo(url) {
            apiClient.get(url)
                .then(response => {
                    document.querySelector('.main-content').innerHTML = response.data; // Nur den Inhalt ersetzen
                })
                .catch(error => {
                    console.error('Error beim Navigieren:', error);
                    if (error.response && error.response.status === 401) {
                        window.location.href = '/finance-management';
                    } else {
                        alert('Navigation fehlgeschlagen');
                    }
                });
        }

        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.getAttribute('href')) {
                e.preventDefault();
                navigateTo(e.target.getAttribute('href'));
            }
        });

        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/finance-management';
        }

        function transferMoney() {
            const recipientId = document.getElementById('recipient').value;
            const amount = document.getElementById('amount').value;

            console.log('Überweisung:', { recipientId, amount });
            console.log('Aktueller Token:', localStorage.getItem('jwtToken')); // Debugging-Log

            apiClient.post('/api/auth/transfer', { recipientId, amount })
                .then(response => {
                    console.log('Überweisung erfolgreich:', response.data);
                    navigateTo('/dashboard');
                })
                .catch(error => {
                    console.error('Error bei der Überweisung:', error);
                    alert('Überweisung fehlgeschlagen');
                });
        }
    </script>
</head>
<body>
<main class="main-content">

<div class="auth-container">
    <div class="auth-box">
        <h1 class="auth-title">Finanzverwaltung - Login</h1>
        <div th:if="${param.error}" class="message error">
            <p>Ungültige Anmeldedaten. Bitte versuchen Sie es erneut.</p>
        </div>

        <div th:if="${param.logout}" class="message success">
            <p>Sie haben sich erfolgreich ausgeloggt!</p>
        </div>

        <form id="loginForm" class="auth-form" onsubmit="login(event)">
            <div class="form-group">
                <label for="username">E-Mail:</label>
                <input type="text" id="username" name="username" required class="form-input"/>
            </div>
            <div class="form-group">
                <label for="password">Passwort:</label>
                <input type="password" id="password" name="password" required class="form-input"/>
            </div>
            <button type="submit" class="auth-button">Anmelden</button>
        </form>

        <div class="auth-links">
            <p>Noch kein Konto? <a th:href="@{/register}">Hier registrieren</a></p>
        </div>
    </div>
</div>
</main>
</body>
</html>
